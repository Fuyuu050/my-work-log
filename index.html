<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ™‚åŠ©æ‰‹ Pro+</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://fav.farm/ğŸ•’">
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f4f7f9; color: #333; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); width: 100%; max-width: 360px; text-align: center; }
        .summary-box { display: flex; justify-content: space-around; margin: 15px 0; gap: 10px; }
        .stat-item { background: #e7f3ff; color: #007bff; padding: 10px; border-radius: 12px; flex: 1; font-size: 13px; font-weight: bold; }
        button { width: 100%; padding: 14px; margin: 6px 0; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-in { background: #28a745; color: white; }
        .btn-out { background: #007bff; color: white; }
        .btn-manual { background: #6c757d; color: white; }
        .btn-export { background: #ffc107; color: #333; margin-top: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; }
        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .log-list { margin-top: 20px; width: 100%; max-width: 360px; }
        li { background: white; margin-bottom: 8px; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .btn-del { background: #fee2e2; color: #ef4444; border: none; padding: 5px 8px; border-radius: 6px; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <div id="clock" style="font-size: 1.5rem; font-weight: bold;">00:00:00</div>
    <div class="summary-box">
        <div class="stat-item">ä»Šæ—¥æ·¨å·¥æ™‚<br><span id="today-h">0h 0m</span></div>
        <div class="stat-item" style="background: #f0fdf4; color: #16a34a;">æœ¬æœˆç¸½ç´¯è¨ˆ<br><span id="month-h">0h 0m</span></div>
    </div>
    <button class="btn-in" onclick="addLog('ä¸Šç­')">â–¶ ç¾åœ¨ä¸Šç­æ‰“å¡</button>
    <button class="btn-out" onclick="addLog('ä¸‹ç­')">â–  ç¾åœ¨ä¸‹ç­æ‰“å¡</button>
    <button class="btn-manual" onclick="toggleModal(true)">ğŸ•’ è£œç°½/ä¿®æ­£ç´€éŒ„</button>
    <button class="btn-export" onclick="exportCSV()">ğŸ“ åŒ¯å‡ºæœ¬æœˆå ±è¡¨</button>
</div>

<div id="manualModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">æ‰‹å‹•è£œç°½</h3>
        <select id="m-type"><option value="ä¸Šç­">ä¸Šç­</option><option value="ä¸‹ç­">ä¸‹ç­</option></select>
        <input type="datetime-local" id="m-datetime">
        <button class="btn-in" onclick="saveManualLog()">ç¢ºèªå„²å­˜</button>
        <button style="background:#eee; color:#333;" onclick="toggleModal(false)">å–æ¶ˆ</button>
    </div>
</div>

<div class="log-list">
    <h3 style="font-size: 14px; color: #666;">æœ€è¿‘ç´€éŒ„ (é»æ“Š ğŸ—‘ï¸ å¯åˆªé™¤å–®ç­†)</h3>
    <ul id="logList"></ul>
</div>

<script>
    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-TW', {hour12:false}); }
    setInterval(updateClock, 1000); updateClock();

    function toggleModal(show) {
        const modal = document.getElementById('manualModal');
        modal.style.display = show ? 'flex' : 'none';
        if(show) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('m-datetime').value = now.toISOString().slice(0, 16);
            // è‡ªå‹•å»ºè­°é¡å‹
            const logs = JSON.parse(localStorage.getItem('workLogs') || "[]");
            if(logs.length > 0) document.getElementById('m-type').value = (logs[0].type === 'ä¸Šç­') ? 'ä¸‹ç­' : 'ä¸Šç­';
        }
    }

    function addLog(type) {
        const now = new Date();
        saveToStorage({ type, timestamp: now.getTime(), date: now.toLocaleDateString('zh-TW'), time: now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false}) });
    }

    function saveManualLog() {
        const dt = new Date(document.getElementById('m-datetime').value);
        if(!dt.getTime()) return alert("è«‹é¸æ“‡æ™‚é–“");
        saveToStorage({ type: document.getElementById('m-type').value, timestamp: dt.getTime(), date: dt.toLocaleDateString('zh-TW'), time: dt.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false}) });
        toggleModal(false);
    }

    function saveToStorage(entry) {
        let logs = JSON.parse(localStorage.getItem('workLogs') || "[]");
        logs.push(entry);
        logs.sort((a, b) => b.timestamp - a.timestamp);
        localStorage.setItem('workLogs', JSON.stringify(logs));
        render();
    }

    function deleteLog(index) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
            let logs = JSON.parse(localStorage.getItem('workLogs') || "[]");
            logs.splice(index, 1);
            localStorage.setItem('workLogs', JSON.stringify(logs));
            render();
        }
    }

    function calculateStats(logs, filterMonth = false) {
        const today = new Date().toLocaleDateString('zh-TW');
        const thisMonth = new Date().getMonth();
        let filtered = [...logs].sort((a,b) => a.timestamp - b.timestamp);
        
        if(!filterMonth) filtered = filtered.filter(l => l.date === today);
        else filtered = filtered.filter(l => new Date(l.timestamp).getMonth() === thisMonth);

        // æŒ‰æ—¥æœŸåˆ†çµ„è¨ˆç®—ï¼ˆç‚ºäº†æ¯æ—¥æ‰£é™¤åˆä¼‘ï¼‰
        const days = {};
        filtered.forEach(l => {
            if(!days[l.date]) days[l.date] = [];
            days[l.date].push(l);
        });

        let grandTotalMin = 0;
        for(let d in days) {
            let dayMs = 0, lastIn = null;
            days[d].forEach(l => {
                if(l.type === 'ä¸Šç­') lastIn = l.timestamp;
                else if(l.type === 'ä¸‹ç­' && lastIn) { dayMs += (l.timestamp - lastIn); lastIn = null; }
            });
            let dayMin = Math.floor(dayMs / 60000);
            if(dayMin >= 300) dayMin -= 60; // æ»¿5å°æ™‚æ‰£1å°æ™‚åˆä¼‘
            grandTotalMin += Math.max(0, dayMin);
        }
        return { h: Math.floor(grandTotalMin/60), m: grandTotalMin%60 };
    }

    function render() {
        const logs = JSON.parse(localStorage.getItem('workLogs') || "[]");
        const today = calculateStats(logs, false);
        const month = calculateStats(logs, true);
        document.getElementById('today-h').innerText = `${today.h}h ${today.m}m`;
        document.getElementById('month-h').innerText = `${month.h}h ${month.m}m`;

        document.getElementById('logList').innerHTML = logs.slice(0, 10).map((l, idx) => `
            <li>
                <div style="text-align:left">
                    <b style="color:${l.type==='ä¸Šç­'?'#28a745':'#007bff'}">${l.type}</b><br>
                    <small>${l.date} ${l.time}</small>
                </div>
                <button class="btn-del" onclick="deleteLog(${idx})">ğŸ—‘ï¸</button>
            </li>
        `).join('');
    }

    function exportCSV() {
        const logs = JSON.parse(localStorage.getItem('workLogs') || "[]");
        const sorted = [...logs].sort((a, b) => a.timestamp - b.timestamp);
        let csv = "\uFEFFæ—¥æœŸ,é¡å‹,æ™‚é–“,å‚™è¨»\n";
        sorted.forEach(l => csv += `${l.date},${l.type},${l.time},\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
        a.download = `å·¥æ™‚å ±è¡¨_${new Date().toLocaleDateString()}.csv`; a.click();
    }

    function clearLogs() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('workLogs'); render(); } }
    render();
</script>
</body>
</html>
